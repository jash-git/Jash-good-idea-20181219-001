var Post={data:{},init:function(){if(typeof page!="undefined"&&page==="detail"){this.data.s_l_to='none';if($("#ac").length>0){this.data.s_l_to=$("#ac").attr("ac");}
this.loadPV();this.showMobileFixedShare();}
if(typeof page!="undefined"&&page==="check"){}
if(typeof ckCopyrightCon!='undefined'&&ckCopyrightCon!==''){this.ckCopyright.init();}},showLike:function(){var fbPage=(typeof fb_page!='undefined')?fb_page:'',fbLikePage=(typeof enter_ad_bchannel!='undefined'&&enter_ad_bchannel!='')?'https://www.facebook.com/'+enter_ad_bchannel:'',canShowWinLike=(typeof isNotShowWinLike=='undefined'||!isNotShowWinLike)?true:false,noShowWinLike=false;if(typeof noShowWinLikeDomain!='undefined'){var dDomain=document.domain;for(var i in noShowWinLikeDomain){if(dDomain===noShowWinLikeDomain[i]||dDomain.indexOf(noShowWinLikeDomain[i])>=0){noShowWinLike=true;}}}
if(fb_page!=''&&fbLikePage!=''&&canShowWinLike&&!noShowWinLike){Com.fnShowLike({target:$("#detailMain"),fbPage:fbPage,fbLikePage:fbLikePage});}},loadPV:function(){var self=this,timer=3;setTimeout(function(){Com.sendCrossDate({id:$('.detail_main').attr('data-id')},'//'+trackDomain+'/log/pv');},timer*1000);},setUserBehavior:function(){var self=this,clickCount=0,scrollCount=0;Com.fnOnScroll(function(){var $this=$(this);if($this.scrollTop()!=0&&!Com.fnIsNearBottom({'target':$('html')})){scrollCount++;}});$('html').on('click',function(){clickCount++;});setTimeout(function(){Com.sendCrossDate({t:self.data.s_l_to,ip:s_l_ip,d:s_l_device,h:$(window).scrollTop(),cc:clickCount,sc:scrollCount},imgHost+'/pv/to');},8000);},bindClick:function(){var self=this;$("#wrap").on("click",".btn_click",function(){var $this=$(this),ctype=$this.attr("data-ctype");switch(ctype){case"":break;}});},bindCopy:function(args){Com.fnCopyToClipboard({copyObj:".btn_copy"});},bindRadio:function(args){if(typeof page!="undefined"&&page==="publish"){if($("input[name='Post[is_original]']:checked").attr("id")==="original"){$("#source").hide();}else{$("#source").show();}
$("input[name='Post[is_original]']").on("click",function(){var id=$(this).attr("id");if(id==="original"){$("#source").hide().find(".input").val("");}else{$("#source").show();}});}},bindCheckTitle:function(){var self=this;$("#wrap").on("keyup blur",".cktitle",function(){var $this=$(this);if($this.val()!=""){self.fnCheckTitle({target:$(this)});}});},fnCheckTitle:function(args){var self=this;if(!self.isChecking){self.isChecking=true;var $this=$(args.target),$parentsObj=$this.parents(".ui_text"),data={post_id:$this.attr("data-id"),original_url:$("#source").find(".input").val(),title:$this.val()};OMIS.doAjax({success:function(html){($parentsObj.children(".ckrepeat").length!=0)&&$parentsObj.children(".ckrepeat").remove();if(html!=""){$parentsObj.append(html);var $ckrepeatObj=$parentsObj.find(".ckrepeat");$ckrepeatObj.off().on("click",".btn_close",function(){var ids=$(this).attr("data-ids");if($("#chktitleIds").length>0){$("#chktitleIds").val(ids);}else{$parentsObj.append('<input id="chktitleIds" type="hidden" value="ids" />');}
$ckrepeatObj.remove();});}
self.isChecking=false;},options:{dataType:"html",url:"/post/chktitle",data:data}});}},bindCheckrepeat:function(){var self=this;$("#wrap").on("click",".checkrepeat",function(){var $this=$(this),original_url=$("#source").find(".input").val(),title=$this.parent().find(".input").val();encodedUrl=encodeURIComponent(original_url),encodedTitle=encodeURIComponent(title),this.href="/post/checkrepeat?orginal_url="+encodedUrl+"&title="+encodedTitle;this.target="_blank";});},bindPopupAd:function(){if(showPopupAd==="true"){var self=this,$fbShareObj=$(".detail_main").children(".footer").children(".share"),isShowed=false;Com.fnOnScroll(function(){var $this=$(this),objTop=$fbShareObj.offset().top,winScrollTop=$this.scrollTop();if(winScrollTop>=objTop&&!isShowed){isShowed=true;self.fnShowPopupAd();}});}},fnShowPopupAd:function(){OMIS.dialog({id:"winAd",html:$.templates("#tpl_winAd").render(),onBeforeShow:function(){var Adchannel='6819165943',html=p_ad_html;if(ShowAdChannel){html+='data-ad-channel="'+Adchannel+'"';}
html+='></ins>';$(this.target).find(".adunit").html(html);loadDoc.loader(["//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"],function(){(adsbygoogle=window.adsbygoogle||[]).push({});});$("#winAd_mask").on("click",function(){OMIS.dialog.close("winAd");});},onShow:function(){$(this.target).addClass("show");}});},bindRepeat:function(){$("#wrap").on("click",".btn_repeat",function(){var $this=$(this),href=$this.attr("data-href")||"";if(href){window.location.href=href;}else{var html=$.templates("#tpl_win_postId").render(),data={"repeatid":"","id":"","is_repeat":""};Com.fnPopupWin({id:"win_repeat",title:"填寫Post ID",content:html,showBtn:true,onShow:function(){},doneReturn:true,doneCallback:function(args){var $winDone=$(this);if($winDone.attr("clickable")===undefined||$winDone.attr("clickable")==="true"){$winDone.attr("clickable","false");var reportObj=$("#win_repeat"),postIDObj=reportObj.find("input[name='repeatid']"),iDObj=reportObj.find("input[name='id']"),isRepeatObj=reportObj.find("input[name='is_repeat']");data.repeatid=postIDObj.val();data.id=iDObj.val();data.is_repeat=isRepeatObj.val();if(data.repeatid){OMIS.doAjax({success:function(json){if(json.status){Com.fnPopupWin({id:"win_tips",content:'<p class="right"><i class="ui_icon icon_right"></i><span>'+$lang["winTips"]["提交成功"]+'</span></p>',expiry:1200,mask:false,showCloseIcon:false});}
$winDone.attr("clickable","true");OMIS.dialog.close("win_repeat");window.location.reload();},options:{"url":"/check/repeat","data":data}});}else{$winDone.attr("clickable","true");if(!data.repeatid){postIDObj.siblings(".error").text($lang["winReport"]["請填寫重複的Post ID"]);}else{postIDObj.siblings(".error").text("");}}}}});}});},showMobileFixedShare:function(){if($('.fixedShare').length>0&&!OMIS.os.desktop){var self=this,topValue=0,timer=null,$fixedShare=$('.fixedShare');Com.fnOnScroll(function(){if(timer==null){timer=setInterval(function(){if($(this).scrollTop()==topValue){clearInterval(timer);timer=null;var $detailMain=$('.detail_main'),detailStart=$detailMain.offset().top,detailEnd=detailStart+$detailMain.outerHeight()-$(window).height();if(topValue>=detailStart&&topValue<=detailEnd){if(!$fixedShare.hasClass('active')){var $tw_gemini_iframe_bottom=$('.tw_gemini_iframe_bottom'),bottom=25;if($tw_gemini_iframe_bottom.length>0){bottom=$tw_gemini_iframe_bottom.outerHeight();}
$fixedShare.css('bottom',bottom).show('fast',function(){$fixedShare.addClass('active');});}}}else{if($fixedShare.hasClass('active')){$fixedShare.removeClass('active').hide();}}},0.8*1000);}else{if($fixedShare.hasClass('active')){$fixedShare.removeClass('active').hide();}}
topValue=$(this).scrollTop();});}},sidebarScrollFixed:function(){if($('.sidebar').children('.scrollFixed').length>0&&window.innerWidth>800){var $fixedObj=$('.sidebar').children('.scrollFixed'),isFixed=false,fixedObjTop=$fixedObj.offset().top,fixedObjWidth=$fixedObj.outerWidth(true),fObjTop=$('#footer').offset().top,winHeight=$(window).height(),bodyHeight=$('body').height();Com.fnOnScroll(function(){var scrollTop=$(this).scrollTop(),scrollBottom=bodyHeight-winHeight-scrollTop,fObjHeight=$('#footer').outerHeight();if(!isFixed){fixedObjTop=$fixedObj.offset().top;}
if(scrollTop>=fixedObjTop){isFixed=true;$fixedObj.css({position:'fixed',top:0,width:fixedObjWidth,zIndex:9});}else{isFixed=false;$fixedObj.css({position:'',width:'',top:'',zIndex:''});}});}},loadPingTrack:function(){this.pingTrack();},pingTrack:function(){if($("#ac").length>0){var $container=$("#ac"),_tu=$container.attr("tu");var wt=200;setTimeout(function(){var $container=$("#ac"),_h=$(window).scrollTop(),_img=imgHost+"/images/2016"+$container.attr("ac")+"042976476567.png?h="+_h+"&sid="+h_l_ip;$container.append("<img src=\""+_img+"\" width=\"1\" height=\"1\">");},wt);var exp=new Date();exp.setTime(exp.getTime()+2*60*1000);$.cookie("post_tracked","4",{expires:exp,path:"/"});this.pingTrackTimer({max:wt});}},pingTrackTimer:function(args){console.log('pingTrackTimer',args);var self=this,t=0,max=args.max,timer=setInterval(function(){t++;if(t>=max){clearInterval(timer);return;}},1);Com.fnOnUnload(function(){console.log('onbeforeunload t max',t,max);clearInterval(timer);if(t<max){self.pingTrackCallback('type=t&time='+t);}});},pingTrackCallback:function(str){if($("#ac").length>0){console.log('pingTrackCallback',str);var $container=$("#ac"),img=imgHost+'/images/blue'+$container.attr("ac")+'.gif?'+str;$container.append("<img src=\""+img+"\" width=\"1\" height=\"1\">");}},publish:{init:function(){this.bindRemoteImg();this.bindCrawler();},bindRemoteImg:function(){var self=this,$obj=$(".remoteimg"),$fileObj=$obj.find('.file[name="uploadImg"]'),fileObj=$fileObj.get(0);$fileObj.on("change",function(){var $imgObj=$obj.find(".img");if(fileObj.files){var f=fileObj.files[0];var reader=new FileReader();reader.onload=function(e){var data=e.target.result;if($imgObj.length>0){$imgObj.find('img').attr("src",data);}else{var html='<div class="nolabel"><div class="img"><img src="'+data+'"></div></div>'
$obj.append(html);}};reader.readAsDataURL(f);}else{if($imgObj.length>0){$imgObj.find('img').attr("src",fileObj.value);}else{var html='<div class="nolabel"><div class="img"><img src="'+fileObj.value+'"></div></div>';$obj.append(html);}}});var $input=$obj.find('.input[name="remote_img"]');$input.on('blur',function(){var $this=$(this),src=$this.val(),$imgObj=$obj.find(".img");if(src!=''){if($imgObj.length>0){$imgObj.find('img').attr("src",src);}else{var html='<div class="nolabel"><div class="img"><img src="'+src+'"></div></div>';$obj.append(html);}}});},bindCrawler:function(){var self=this;$("#wrap").on("click",".btn_crawler",function(){self.fnCrawler({target:$(this)});});$("#wrap").on("click",".btn_crawler_tips",function(){Com.fnPopupWin({id:"win_crawler_tips",title:'可採集的域名列表',content:$.templates("#tpl_win_crawler_tips").render()});});},fnCrawler:function(args){var self=this;if(!self.isCrawler){self.isCrawler=true;var $this=$(args.target),$parentsObj=$this.parents(".ui_text").find('.content'),data={url:$.trim($parentsObj.find('.input').val())};if(data.url!=''){Com.fnPopupWin({id:"win_crawler",content:'<div class="loadWrap"><div style="text-align:center;margin-bottom:10px;">採集文章中...請耐心等待！</div><div class="ui_loading" style="margin:0 auto;position:static;"></div></div>',showCloseIcon:false});OMIS.doAjax({success:function(json){if(!json.error){if(json.title){$('.cktitle').val(json.title);Post.fnCheckTitle({target:$('.cktitle')});}
if(json.content){editor.setContent('');editor.execCommand('insertHtml',json.content);}}else{Com.fnPopupWin({id:"win_tips",content:'<p class="error"><i class="ui_icon icon_note3"></i><span>'+json.error+'</span></p>',expiry:3500,mask:false,showCloseIcon:false});}
OMIS.dialog.close("win_crawler");self.isCrawler=false;},error:function(){Com.fnPopupWin({id:"win_tips",content:'<p class="error"><i class="ui_icon icon_note3"></i><span>出錯了，請稍後再試。</span></p>',expiry:3500,mask:false,showCloseIcon:false});OMIS.dialog.close("win_crawler");self.isCrawler=false;},options:{type:'GET',url:"/post/crawler",data:data}});}}}},ckCopyright:{data:{page:(typeof page!="undefined")?page:'',con:(typeof ckCopyrightCon!='undefined')?ckCopyrightCon:'',type:(typeof ckCopyrightType!="undefined")?ckCopyrightType:'',sitesearch:(typeof sitesearch!="undefined")?sitesearch:'',divObj:(typeof divObj!="undefined")?divObj:''},init:function(){if(this.data.divObj===''){if(typeof page!="undefined"&&page==="detail"){this.data.divObj="ckcopyright_results";}else{this.data.divObj="results";}}
var $obj=$('<div id="'+this.data.divObj+'" style="display: none;"></div>'),cx='011179511611866005308:3jkxonxxtmi',gcseUrl=(document.location.protocol=='https:'?'https:':'http:')+'//www.google.com/cse/cse.js?cx='+cx;loadDoc.loader([gcseUrl],function(){$('#wrap').append($obj);});},gcseCallback:function(){var self=Post.ckCopyright;if(self.data.con!==''){if(document.readyState!='complete'){return google.setOnLoadCallback(self.gcseCallback,true);}
google.search.cse.element.render({gname:'gsearch',div:self.data.divObj,tag:'search',attributes:{linkTarget:'',as_sitesearch:self.data.sitesearch}});var element=google.search.cse.element.getElement('gsearch');element.execute(self.data.con);if(self.data.page==="detail"){self.ckResults();}}},ckResults:function(){var self=this,max=100,num=0,timer=setInterval(function(){var $obj=$('.gs-result:not(.gs-no-results-result)','#'+self.data.divObj);if(typeof $obj!='undefined'&&$obj.length>0){clearInterval(timer);if(self.data.page==="detail"&&self.data.type==='send'){Com.fnPopupWin({id:"win_ckcopyright",title:'唷！文章有侵犯版权哦～',content:$('#'+self.data.divObj).html()});}
self.sendCopyright({copyright:1});}else{num++;var $noResult=$('.gs-no-results-result','#'+self.data.divObj);if(num>max||$noResult.length>0){clearInterval(timer);self.sendCopyright({copyright:2});}}},100);},sendCopyright:function(args){var postId=$('.detail_main').attr('data-id'),data={id:postId};switch(this.data.type){case"send":data.copyright=args.copyright;break;case"chk_con":data.copyright_status=args.copyright;break;}
Com.sendCrossDate(data,imgHost+'/post/Copyrightlog');}}};$(document).ready(function(){Post.init();window.__gcse={callback:Post.ckCopyright.gcseCallback};});